#!/bin/bash

cd "$(dirname "$0")"

set -o errexit -o errtrace -o pipefail
trap 'echo; echo Aborting.' ERR


ln -s `pwd`/vimrc ~/.vimrc


git config --global core.excludesfile `pwd`/gitignore
git config --global push.default simple
git config --global diff.tool vimdiff
git config --global merge.tool vimdiff

cat >>~/.hgrc <<EOF
# This file was generated by $(pwd)/$(basename "$0").

[ui]
ignore = $(pwd)/hgignore
%include $(pwd)/hgrc
EOF


append_if_not_already_in_file()
{
    FILENAME=$1
    TEXT=$2
    grep --quiet --no-messages -x --fixed-strings "$TEXT" "$FILENAME" || echo "$TEXT" >> "$FILENAME"
}

zshrc()  { append_if_not_already_in_file ~/.zshrc "$1"; }
profile()  { append_if_not_already_in_file ~/.profile "$1"; }

append_if_not_already_in_file ~/.bashrc ". `pwd`/bashrc"

profile "export EDITOR='vim -X'"
profile 'export MAKEFLAGS="$MAKEFLAGS -j`getconf _NPROCESSORS_ONLN`"'
profile 'export XZ_DEFAULTS="-T0"'

mkdir -p ~/bin

VIMRUNTIME=`vim -e -T dumb --cmd 'exe "set t_cm=\<C-M>"|echo $VIMRUNTIME|quit' | tr -d '\015'`  # (from Vim's help for VIMRUNTIME)
ln -sf "$VIMRUNTIME"/macros/less.sh ~/bin/vimless  # xxx Vim's runtime path could change in future, e.g. when running a different version of Vim (note that "$VIMRUNTIME" is part of the symlink target); Make ~/bin/vimless a script that runs "$VIMRUNTIME/macros/less.sh" after determining the current Vim runtime path.

zshrc "set_output_carriage_return_with_new_line() { stty onlcr }"
zshrc "autoload -Uz add-zsh-hook"
zshrc "add-zsh-hook precmd set_output_carriage_return_with_new_line  # zsh on Ubuntu 18.04.1 using WSL: Something (I don't know what) was often mucking up the terminal settings (new-lines output without carriage returns) - This is a workaround."

zshrc "disable -r time && alias time='time -f \"%E real, %U user, %S system\" ' # I like the wall-clock time to be output first. (zsh's in-built time command outputs it last.) zsh's in-built time command outputs to stdout. (This will output to stderr?)"


# Install z command for use from bash command line. z changes directory - pass it part of the pathname of a previously visited directory.
if [ ! -f ~/bin/z/z.sh ]; then
    git clone https://github.com/rupa/z.git ~/bin/z
fi
