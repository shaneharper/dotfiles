#!/bin/bash

cd "$(dirname "$0")"

set -o errexit -o errtrace -o pipefail
trap 'echo; echo Aborting.' ERR


ln -si `pwd`/vimrc ~/.vimrc

ln -si `pwd`/dircolors ~/.dircolors

git config --global core.excludesfile `pwd`/gitignore
git config --global diff.tool vimdiff
git config --global init.defaultBranch master  # Silence "git init" message: "Using 'master' as the name for the initial branch. This default branch name is subject to change. ..."
git config --global merge.tool vimdiff
git config --global push.default simple
git config --global color.decorate.tag 'green italic'

cat >>~/.hgrc <<EOF
# This file was generated by $(pwd)/$(basename "$0").

[ui]
ignore = $(pwd)/hgignore
%include $(pwd)/hgrc
EOF


append_if_not_already_in_file()
{
    FILENAME=$1
    TEXT=$2
    grep --quiet --no-messages -x --fixed-strings "$TEXT" "$FILENAME" || echo "$TEXT" >> "$FILENAME"
}

zshrc()  { append_if_not_already_in_file ~/.zshrc "$1"; }
profile()  { append_if_not_already_in_file ~/.profile "$1"; }

append_if_not_already_in_file ~/.bashrc ". `pwd`/bashrc"

profile "export EDITOR='vim -X'"
profile 'export MAKEFLAGS="$MAKEFLAGS -j`getconf _NPROCESSORS_ONLN`"'
profile 'export XZ_DEFAULTS="-T0"'

mkdir -p ~/bin

zshrc "set_output_carriage_return_with_new_line() { stty onlcr }"
zshrc "autoload -Uz add-zsh-hook"
zshrc "add-zsh-hook precmd set_output_carriage_return_with_new_line  # zsh on Ubuntu 18.04.1 using WSL: Something (I don't know what) was often mucking up the terminal settings (new-lines output without carriage returns) - This is a workaround."

zshrc "disable -r time && alias time='time -f \"%E real, %U user, %S system\" ' # I like the wall-clock time to be output first. (zsh's in-built time command outputs it last.) zsh's in-built time command outputs to stdout. (This will output to stderr?)"


# Install z command for use from bash command line. z changes directory - pass it part of the pathname of a previously visited directory.
if [ ! -f ~/bin/z/z.sh ]; then
    git clone https://github.com/rupa/z.git ~/bin/z
fi

echo About to install python3-dev and mono-complete.
sudo apt install --assume-yes python3-dev mono-complete  # Install packages needed by YouCompleteMe Vim plugin.  xxx It'd be nice to only ask for a password (run sudo) if a required packages isn't installed - See https://stackoverflow.com/a/10439058. xxx Move this to vimrc to be near the code that installs YouCompleteMe.

if [[ $(uname -r | grep WSL) ]]; then
    sudo update-binfmts --package 'mono-runtime' --remove cli /usr/bin/mono  # Without this (and with mono-runtime - part of mono-complete - installed and with systemd enabled) trying to run a Windows exe from WSL/Ubuntu doesn't work, e.g. "run-detectors: unable to find an interpreter for /mnt/c/Windows/system32/cmd.exe" is output when trying to run cmd.exe (Ubuntu 22.04.3, mono-runtime 6.8.0.105+dfsg-3.2).
fi
